name: Auto-Fix and Build EcoBridge

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch: # 支持手动点击运行

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'oracle' # Oracle JDK 对 Java 25 早期特性的支持较好
          cache: 'gradle'

      # [核心步骤] 检查并补全 Gradle Wrapper
      - name: Setup Gradle and Generate Wrapper
        run: |
          # 检查是否存在 gradlew，不存在则使用系统预装的 gradle 生成它
          if [ ! -f gradlew ]; then
            echo "Gradlew not found, generating wrapper..."
            gradle wrapper --gradle-version 8.10.2 # 建议使用支持 Java 21+ 的稳定 Gradle 版本
          fi
          # 确保有执行权限
          chmod +x gradlew

      - name: Build with Gradle (SIMD Optimized)
        # --no-daemon 适合 CI 环境，减少内存占用
        # 这里的编译会应用你 build.gradle.kts 中的 --enable-preview 和 Vector 模块参数
        run: ./gradlew shadowJar --no-daemon

      - name: Extract Build Metadata
        id: metadata
        run: |
          # 定位生成的 Shadow Jar 文件
          JAR_FILE=$(find build/libs -name "*-all.jar" -o -name "*.jar" | head -n 1)
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.metadata.outputs.jar_name }}
          path: ${{ steps.metadata.outputs.jar_path }}
          retention-days: 5