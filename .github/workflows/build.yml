name: Build EcoBridge

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'oracle'
          cache: 'gradle'

      - name: Setup Gradle and Generate Wrapper
        run: |
          # 检查根目录下是否有 gradlew，没有则生成
          if [ ! -f gradlew ]; then
            echo "Gradlew not found, generating wrapper..."
            gradle wrapper --gradle-version 9.3.0
          fi
          chmod +x gradlew

      - name: Build with Gradle (shadowJar)
        # 直接在根目录运行，不再需要 working-directory
        run: ./gradlew shadowJar --no-daemon

      - name: Extract Build Metadata
        id: metadata
        run: |
          # 在 build/libs 目录下寻找生成的 jar 文件
          JAR_FILE=$(find build/libs -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "Error: No JAR file found in build/libs"
            exit 1
          fi
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.metadata.outputs.jar_name }}
          path: ${{ steps.metadata.outputs.jar_path }}
          retention-days: 5
