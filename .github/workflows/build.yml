name: Auto-Fix and Build EcoBridge

on:
  push:
    branches: [ "master", "web" ]
  pull_request:
    branches: [ "master", "web" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'oracle'
          cache: 'gradle'

      # [核心修正] 在子目录中生成并检查 Gradle Wrapper
      - name: Setup Gradle and Generate Wrapper
        # 请根据你的实际目录结构修改下面的 working-directory
        working-directory: ./EcoBridge_Project 
        run: |
          if [ ! -f gradlew ]; then
            echo "Gradlew not found in subdirectory, generating wrapper..."
            gradle wrapper --gradle-version 9.3.0
          fi
          chmod +x gradlew

      - name: Build with Gradle (SIMD Optimized)
        # 同样需要指定工作目录
        working-directory: ./EcoBridge_Project
        run: ./gradlew shadowJar --no-daemon

      - name: Extract Build Metadata
        id: metadata
        working-directory: ./EcoBridge_Project
        run: |
          # 在子目录的 build/libs 下寻找生成的 jar
          JAR_FILE=$(find build/libs -name "*.jar" | head -n 1)
          echo "jar_path=EcoBridge_Project/$JAR_FILE" >> $GITHUB_OUTPUT
          echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.metadata.outputs.jar_name }}
          # 路径需要从根目录开始算起
          path: ${{ steps.metadata.outputs.jar_path }}
          retention-days: 5
